# PerimeterX 纯算还原 — ifood.com.br

## 1. 项目概述

纯 Node.js 实现 PerimeterX `_px3` cookie 生成，不加载真实 PX SDK，不依赖浏览器环境。

### 硬编码常量 (main3.js line 498)

| 常量 | 值 | 说明 |
|------|-----|------|
| AppID | `PXO1GDTa7Q` | 站点标识 |
| TAG/GT | `DhI0E0h7J2cKHw==` | payload 加密种子 + ob 解码种子 |
| FT | `388` | fingerprint type |
| BI | `dgoMBiMxRCcwUmMj...` (100 chars) | bundle info |
| Collector URL | `https://collector-pxo1gdta7q.px-cloud.net/api/v2/collector` | 收集器端点 |
| /ns URL | `https://tzm.px-cloud.net/ns?c={uuid}` | 网络测速端点 |
| 默认时间戳 | `1604064986000` | 首次请求 payload 交织用的回退值 |

---

## 2. 请求链流程

```
Step 0: uuidV1() → 生成会话 UUID
Step 1: GET /ns?c={uuid} (异步, 不阻塞)
Step 2: 构建 collector#1 events (12 字段)
Step 3: generatePayload(events, null, uuid) + generatePC(events, uuid, TAG, FT)
Step 4: POST collector#1 (seq=0, rsc=1, 无 vid/cts/cs/sid)
Step 5: 收到 ob#1 响应 → processOb(body, GT) → 解出 state
        state.vid    → _pxvid cookie / vid= 参数
        state.cts    → cts= 参数
        state.qa     → cs= 参数
        state.no     → 服务器时间戳 (payload 交织 + sid 隐写 + hash 计算)
        state.pxsid  → sid 的 UUID 部分
        state.to     → anti-tamper XOR 种子
        state.px3    → _px3 cookie (ob#1 即返回)
Step 6: 等待 /ns 完成 → nsResult.sm, nsResult.duration
Step 7: 构建 collector#2 events (203 字段, 含浏览器指纹)
Step 8: generatePayload(events, state.no, uuid) + generatePC(events, uuid, TAG, FT)
Step 9: POST collector#2 (seq=2, rsc=2, 带 vid/cts/cs/sid)
Step 10: 收到 ob#2 响应 → processOb(body, GT) → 解出新 state
         ob#2 可能返回 bake|_px3|... 指令 (更新 _px3)
         {"do":null} 表示服务端接受 (成功)
         {"do":[]} 表示服务端拒绝 (失败)
```

### POST 参数模板

```
payload={encodeURIComponent(payload)}
&appId=PXO1GDTa7Q
&tag={encodeURIComponent(TAG)}
&uuid={encodeURIComponent(uuid)}
&ft=388
&seq={0|2}
&en=NTA
&bi={encodeURIComponent(BI)}
&cs={encodeURIComponent(cs)}        ← collector#2 才有
&pc={encodeURIComponent(pc)}
&sid={encodeURIComponent(sid)}      ← collector#2 才有
&vid={encodeURIComponent(vid)}      ← collector#2 才有
&cts={encodeURIComponent(cts)}      ← collector#2 才有
&rsc={1|2}
```

---

## 3. 核心算法模块

所有模块位于 `ifood_PerimeterX-WAF_jsReverse/px_reverse/reverse/`。

### 3.1 payload.js — payload 加密/解密

**算法链:**
```
events → serialize(events)        — PX 自定义 JSON 序列化
       → XOR(json, 50)            — 逐字符异或 50
       → base64_utf8(xored)       — UTF-8 base64 编码
       → interleave(key, b64)     — UUID 驱动交织
```

**交织 (interleave) 算法:**
1. `key = XOR(base64_utf8(serverTimestamp), 10)` — 20 字符交织密钥
2. `offsets = getOffsets(key.length, b64.length, uuid)` — 基于 UUID 的伪随机插入位置
3. 将 key 的每个字符插入 b64 的 offsets 位置

**偏移量计算 (getOffsets):**
1. `h = XOR(base64_utf8(uuid), 10)` — UUID 的 XOR 编码
2. 双层循环: `product = h.charCodeAt(col) * h.charCodeAt(row)`
3. 超范围时用 `Qf()` 线性缩放到 [0, payloadLen-1]
4. 碰撞时 `+1` 直到唯一
5. 排序后返回

**关键:** base64 编码必须用 **UTF-8** (`Buffer.from(t, 'utf-8').toString('base64')`)，不能用 Latin-1/binary。SDK 的 `z()` 函数 (main.js line 224) 先做 `encodeURIComponent` (UTF-8 编码) 再 `btoa`。

### 3.2 pc.js — payload checksum

**算法链:**
```
events → serialize(events)                     — PX 自定义 JSON 序列化 (和 payload 相同)
       → HMAC-MD5(data=json, key=uuid:tag:ft)  — 32 hex chars
       → 分离数字/字母
       → digits + (letters.charCode % 10)
       → 间隔取 [0],[2],[4],...                 — ~16 位纯数字
```

**HMAC-MD5 实现:** 完整的 MD5 + HMAC 包装。`hmacMD5(data)` = 普通 MD5，`hmacMD5(data, key)` = HMAC-MD5。

**PX 自定义 JSON 序列化 (serialize):**
与标准 `JSON.stringify` 的差异:
- `undefined` → `"undefined"` (带引号)
- `NaN` / `Infinity` → `"null"`
- `RegExp` → `"null"`
- `Date` → `"YYYY-M-DTHH:MM:SS.mmm"` (不补零)
- 属性值为 `undefined` 时输出 `"undefined"` 而非跳过

### 3.3 ob.js — ob 响应解码

**算法链:**
```
response.do → base64_decode(binary)
            → XOR(xorKey)                  — xorKey = ml(gt) % 128
            → split("~~~~")                — 段分割
            → 每段: split("|"), shift()     — 第一个字段是 handler key (丢弃)
            → 按参数特征自动匹配 handler
```

**ml(gt) 哈希 (main.js:2131):**
```javascript
function ml(t) {
    let e = 0;
    for (let n = 0; n < t.length; n++)
        e = (31 * e + t.charCodeAt(n)) % 2147483647;
    return (e % 900 + 100).toString();
}
```

**handler 类型 (按参数特征匹配, 不依赖 key 名):**

| handler | 匹配规则 | 设置的 state |
|---------|---------|------------|
| timestamp | 1 arg, 13 位时间戳 | `state.no` |
| challenge_hash | 1 arg, 64 hex | `state.qa` (→ cs 参数) |
| vid | 3 args, UUID + 数字 + flag | `state.vid` |
| cts | 2 args, UUID + flag | `state.cts` |
| pxsid | 1 arg, UUID | `state.pxsid` |
| session_id | 1-2 args, 16+ 位数字 | `state.to` |
| status_code | 1 arg, 3 位数字 | `state.ao` |
| set_cookie | 4+ args, 含 `_px` | `state.px3` |
| pow_start | 5 args, 含 64hex hash | PoW 求解 |
| control_flag | 1 arg, 2-4 字母 | `state.jf` |

**OB 解码使用 binary base64 (正确):** 服务端生成的数据不经过 SDK 的 `z()` 函数，直接用 `Buffer.from(ob, 'base64').toString('binary')`。

### 3.4 sid.js — SID 隐写编码

**算法:**
```
sid = pxsid + hh(serverTimestamp)
hh(t): 每个字符 → String.fromCodePoint(0xE0100 + charCode)
```

将时间戳的每个数字字符编码为 Unicode Tag Characters (Plane 14)，如 `'1'` (0x31) → U+E0131。

**关键:** SID 的 UUID 部分是 `state.pxsid` (ob 响应返回)，不是会话 UUID。

### 3.5 uuid.js — UUID v1 生成器

标准 UUID v1: 时间戳 (100ns since 1582-10-15) + 随机节点 (6 bytes, 首字节 OR 1)。
- 格里高利历偏移: `122192928e5`
- 14 位随机时钟序列

### 3.6 hash.js — 指纹 hash (RT0/ewBRNUo= 字段)

**算法:**
```
ao = Math.floor(parseInt(serverNo) / 1000)
result = (ao * 2863) / vid.charCodeAt(9)
hash = Kt(Math.floor(result))              — djb2 变体 → 8 位 hex
```

**Kt (djb2 变体):**
```javascript
function Kt(t) {
    t = '' + t;
    var e = 0;
    for (var n = 0; n < t.length; n++) {
        e = (e << 5) - e + t.charCodeAt(n);
        e |= 0;
    }
    if (e < 0) e += 4294967296;
    return e.toString(16);
}
```

### 3.7 memory.js — performance.memory 指纹

随机生成:
- `usedJSHeapSize`: 40-140 MB
- `totalJSHeapSize`: used × 1.1 ~ 1.5
- `jsHeapSizeLimit`: 固定 4294967296 (4GB)

### 3.8 antitamper.js — 防篡改校验

**算法:**
```javascript
key   = te(state.to, state.no % 10 + 2)   // XOR 每个字符
value = te(state.to, state.no % 10 + 1)
event.d[key] = value
```

`state.to` 是 ob 响应返回的 20 位数字字符串，`state.no` 是服务器时间戳。

### 3.9 ns.js — /ns 网络测速

`GET https://tzm.px-cloud.net/ns?c={uuid}` → 返回 `sm` (响应文本) 和 `duration` (耗时 ms)。

---

## 4. collector 字段映射

### 4.1 collector#1 (12 字段)

| 字段 key | 含义 | 值 |
|----------|------|-----|
| `U08pSRUgIH4=` | URL | `"https://www.ifood.com.br/restaurantes"` |
| `ZR1fGyB2Ui4=` | 类型 | `0` |
| `JDxeOmFRVgA=` | 平台 | `"Win32"` |
| `cHAKdjYQB0Y=` | 计数器 | `0` |
| `Rlp8HAA2dy4=` | 性能计时 | `Math.floor(300 + Math.random() * 1600)` |
| `JxsdHWJwFCc=` | 时区偏移 | `3600` |
| `FCwuKlJGKx0=` | initTime | `Date.now()` (会话开始) |
| `BFw+GkE3Oyg=` | 发送时间 | `initTime + random(5, 10)` |
| `eEgCDj4lBjo=` | UUID | 会话 UUID |
| `Ah44WEdyM24=` | /ns 结果 | `null` (首次) |
| `DFQ2Ekk4PSU=` | /ns 耗时 | `0` (首次) |
| `QSE7ZwdLMVw=` | 标记 | `false` |

### 4.2 collector#2 (203 字段)

详细字段列表参见 `test_collector1.js` Step 8。关键动态字段:

| 字段 key | 含义 | 算法 |
|----------|------|------|
| `N2sNLXEGAx4=` | 服务器时间戳 | `state.no` (ob 响应) |
| `RT0/ewBRNUo=` | 指纹 hash | `generateHash(state.no, state.vid)` |
| `dgoMTDBkBXg=` | HMAC vid+UA | `hmacMD5(vid, userAgent)` |
| `dEwOCjImBDk=` | HMAC pxsid+UA | `hmacMD5(pxsid, userAgent)` |
| `BFw+GkEwMyk=` | MD5 vid | `hmacMD5(vid)` |
| `fyNFZTlCSFM=` | HMAC uuid+UA | `hmacMD5(uuid, userAgent)` |
| `Em4oaFcDIF4=` | o111ooo1 | ob 响应中提取 (4-5 位数字) |
| `HUVnQ1sranA=` | state.to | ob 响应 session_id |
| `dEwOCjEkAjA=` | appId | ob 响应 `state.appId` |
| `eWlDLz8ISh0=` | 时间字符串 | `new Date(now).toString()` |
| `YGAaZiYMFV0=` | usedJSHeapSize | `generateMemory().usedJSHeapSize` |
| `FU1vS1MhZ3w=` | jsHeapSizeLimit | 4294967296 |
| `EFAqFlYxJCc=` | totalJSHeapSize | `generateMemory().totalJSHeapSize` |
| `Rlp8HAA2dy4=` | perfNow | `sendTs - initTime` |
| `Yj4YOCRUFgg=` | 当前时间 | `Date.now()` |
| `BX1/O0ATcgo=` | _px3 | ob#1 返回的 px3 值 |
| `Ah44WEdyM24=` | /ns 结果 | `nsResult.sm` |
| `DFQ2Ekk4PSU=` | /ns 耗时 | `nsResult.duration` |
| `STkzfw9VPUU=` | history.length | 纯算固定 `2` |
| `te(to, no%10+2)` | anti-tamper key | 动态 XOR 生成 |

---

## 5. 错误历史与调试过程

### Bug #1: UTF-8 vs Latin-1 base64 编码 (根本原因)

**现象:**
- collector#2 返回 `{"do":[]}` (拒绝)
- 与 SDK 对比: payload 长度差 36 字符 (our=12168, sdk=12132)
- PC 完全不匹配 (our=3227478034498002 vs sdk=2120375267919208)
- 但 collector#3/#4 (单事件) 的 PC 完全一致

**排查过程:**
1. 先怀疑事件字段顺序 → 排除 (字段顺序调整后仍失败)
2. 创建 node bridge 对比 SDK 和纯算的 POST 参数 → 发现 48 个字段值差异 (但 SDK 也成功, 说明字段值容差大)
3. 将 SDK 的事件数据喂入我们的 payload/PC 函数 → **payload 长度不一致**, 锁定加密算法本身有 bug
4. 逐字节对比 serialize 输出 → **序列化完全一致** (排除 serialize)
5. 对比 base64 编码结果 → 发现差异在含中文字符的 `eWlDLz8ISh0=` 字段 (Date.toString() 返回 "中国标准时间")
6. 检查 SDK 源码 `z()` 函数 (main.js line 224): `btoa(encodeURIComponent(t).replace(...))`

**根因:**
```javascript
// SDK 的 z() 函数: UTF-8 编码 → base64
z(t) = btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g, (e,n) => String.fromCharCode('0x'+n)))

// 我们的代码 (BUG): Latin-1 编码 → base64
function b64encode(t) { return Buffer.from(t, 'binary').toString('base64'); }

// 修复后: UTF-8 编码 → base64
function b64encode(t) { return Buffer.from(t, 'utf-8').toString('base64'); }
```

对于 ASCII 字符 (charCode < 0x80), UTF-8 和 Latin-1 编码一致。但 `"中国标准时间"` 中的字符经过 XOR(50) 后产生 ≥0x80 的字符:
- UTF-8: 一个 ≥0x80 字符编码为 2-3 字节
- Latin-1: 一个字符编码为 1 字节

导致 base64 结果不同 → payload 长度差异 → 偏移量不同 → 交织结果完全不同 → PC 校验也不同。

**修复:** `payload.js` 中 `b64encode` 改为 `Buffer.from(t, 'utf-8')`，`b64decode` 改为 `Buffer.from(t, 'base64').toString('utf-8')`。

**验证:** 修复后 payload EXACT MATCH: true, PC MATCH: true。

**注意:** `ob.js` 中的 `Buffer.from(ob, 'base64').toString('binary')` 是**正确的**，因为 ob 响应是服务端生成的数据，不经过 SDK 的 `z()` 函数。

### Bug #2: SID 用了错误的 UUID

**现象:** sid 参数与 SDK 生成的不一致。

**根因:**
```javascript
// BUG: 用了会话 UUID
var sid = generateSid(uuid, obParams.no);

// 修复: 用 ob 响应返回的 pxsid
var sid = generateSid(state.pxsid, obParams.no);
```

`pxsid` 和 `uuid` 是两个**不同的** UUID。`uuid` 是客户端生成的会话标识，`pxsid` 是服务端通过 ob 响应返回的 session ID。

### Bug #3: log 函数丢弃参数

```javascript
// BUG: 只接受一个参数
function log(msg) { process.stderr.write('[TEST] ' + msg + '\n'); }

// 修复: 支持多参数
function log() { process.stderr.write('[TEST] ' + Array.from(arguments).join(' ') + '\n'); }
```

---

## 6. 运行

### 安装依赖

无外部依赖，仅使用 Node.js 内置模块 (`https`, `crypto`)。

### 运行测试

```bash
cd C:\project\ifood-web-reversation\auto
node test_collector1.js
```

**成功输出示例:**
```
[TEST] [Step 0] UUID: xxxxxxxx-xxxx-11f1-xxxx-xxxxxxxxxxxx
[TEST] [Step 5] Response: 200 (xxx bytes)
[TEST] ═══ OB#1 State ═══
[TEST] vid: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
[TEST] px3: xxxxxxxx...
[TEST] [Step 11] Response: 200 (xxx bytes)
[TEST] [Step 11] Body: {"do":null}
[TEST]   collector#1 + collector#2 纯算端到端成功!
```

### 文件结构

```
auto/
  test_collector1.js              — 端到端纯算测试脚本

ifood_PerimeterX-WAF_jsReverse/px_reverse/reverse/
  payload.js                      — payload 加密/解密/交织
  pc.js                           — PC 校验 (HMAC-MD5 + serialize)
  ob.js                           — ob 响应解码 + handler 执行 + PoW
  sid.js                          — SID 隐写编码
  uuid.js                         — UUID v1 生成器
  hash.js                         — RT0/ewBRNUo= 指纹 hash (djb2)
  memory.js                       — performance.memory 随机生成
  antitamper.js                   — 动态 XOR key/value 防篡改
  ns.js                           — /ns 网络测速请求
```

---

## 7. 完整纯算模块 (px_pure.js)

以下是所有算法封装在一个文件中的完整模块，可直接 `require` 使用:

```javascript
/**
 * px_pure.js — PerimeterX 纯算还原完整模块
 *
 * 将 9 个 reverse 模块合并为单文件, 零外部依赖
 * 用法:
 *   const px = require('./px_pure');
 *   const result = await px.run({ userAgent: '...' });
 *   console.log(result.px3, result.pxvid);
 */

const https = require('https');
const crypto = require('crypto');

// ═══════════════════════════════════════════════════════
//  常量
// ═══════════════════════════════════════════════════════

const TAG    = 'DhI0E0h7J2cKHw==';
const FT     = 388;
const APP_ID = 'PXO1GDTa7Q';
const GT     = 'DhI0E0h7J2cKHw==';
const BI     = 'dgoMBiMxRCcwUmMjb1o/JXcvEUFnA0wkehgUS0xGTw92KUQ6MkNOMxhdcX13KAhfdTxJOF4OQGUfXlYYYjVSL2obUXNhDzArbC8QXjBLTHJ6GRcuSklMBHQlQGh/VAo=';
const COLLECTOR_URL = 'https://collector-pxo1gdta7q.px-cloud.net/api/v2/collector';
const DEFAULT_TIMESTAMP = '1604064986000';

// ═══════════════════════════════════════════════════════
//  XOR
// ═══════════════════════════════════════════════════════

function xor(t, key) {
    var r = '';
    for (var i = 0; i < t.length; i++) r += String.fromCharCode(t.charCodeAt(i) ^ key);
    return r;
}

function te(t, e) {
    for (var n = '', r = 0; r < t.length; r++)
        n += String.fromCharCode(e ^ t.charCodeAt(r));
    return n;
}

// ═══════════════════════════════════════════════════════
//  Base64 (UTF-8)
// ═══════════════════════════════════════════════════════

function b64encode(t) {
    return Buffer.from(t, 'utf-8').toString('base64');
}

function b64decode_utf8(t) {
    return Buffer.from(t, 'base64').toString('utf-8');
}

// ═══════════════════════════════════════════════════════
//  PX 自定义 JSON 序列化 (serialize)
// ═══════════════════════════════════════════════════════

var ESCAPE_RE = /[\\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;
var ESCAPE_MAP = {
    '\b': '\\b', '\t': '\\t', '\n': '\\n', '\f': '\\f',
    '\r': '\\r', '\v': '\\v', '"': '\\"', '\\': '\\\\'
};

function escapeChar(ch) {
    return ESCAPE_MAP[ch] || '\\u' + ('0000' + ch.charCodeAt(0).toString(16)).slice(-4);
}

function quoteString(t) {
    ESCAPE_RE.lastIndex = 0;
    return '"' + (ESCAPE_RE.test(t) ? t.replace(ESCAPE_RE, escapeChar) : t) + '"';
}

function serialize(e) {
    var type = typeof e;
    if (type === 'undefined') return '"undefined"';
    if (type === 'boolean') return String(e);
    if (type === 'number') {
        var r = String(e);
        return (r === 'NaN' || r === 'Infinity') ? 'null' : r;
    }
    if (type === 'string') return quoteString(e);
    if (e === null || e instanceof RegExp) return 'null';
    if (e instanceof Date)
        return ['"', e.getFullYear(), '-', e.getMonth() + 1, '-', e.getDate(),
                'T', e.getHours(), ':', e.getMinutes(), ':', e.getSeconds(),
                '.', e.getMilliseconds(), '"'].join('');
    if (Array.isArray(e)) {
        var n = ['['];
        for (var a = 0; a < e.length; a++) n.push(serialize(e[a]) || '"undefined"', ',');
        n[n.length > 1 ? n.length - 1 : n.length] = ']';
        return n.join('');
    }
    var n2 = ['{'];
    for (var o in e) {
        if (e.hasOwnProperty(o) && e[o] !== undefined)
            n2.push(quoteString(o), ':', serialize(e[o]) || '"undefined"', ',');
    }
    n2[n2.length > 1 ? n2.length - 1 : n2.length] = '}';
    return n2.join('');
}

// ═══════════════════════════════════════════════════════
//  MD5 / HMAC-MD5
// ═══════════════════════════════════════════════════════

function w(t) {
    var n = '';
    for (var e = 0; e < 32 * t.length; e += 8)
        n += String.fromCharCode(t[e >> 5] >>> e % 32 & 255);
    return n;
}

function N(t, e) {
    var n = (65535 & t) + (65535 & e);
    return (t >> 16) + (e >> 16) + (n >> 16) << 16 | 65535 & n;
}

function X(t, e, n, r, a, o) {
    var i = N(N(e, t), N(r, o));
    return N(i << a | i >>> 32 - a, n);
}

function k(t, e, n, r, a, o, i) { return X(e & n | ~e & r, t, e, a, o, i); }
function P(t, e, n, r, a, o, i) { return X(e & r | n & ~r, t, e, a, o, i); }
function x(t, e, n, r, a, o, i) { return X(e ^ n ^ r, t, e, a, o, i); }
function C(t, e, n, r, a, o, i) { return X(n ^ (e | ~r), t, e, a, o, i); }

function B(t) {
    var n = [];
    n[(t.length >> 2) - 1] = void 0;
    for (var e = 0; e < n.length; e++) n[e] = 0;
    for (var e2 = 0; e2 < 8 * t.length; e2 += 8)
        n[e2 >> 5] |= (255 & t.charCodeAt(e2 / 8)) << e2 % 32;
    return n;
}

function O(t) { return unescape(encodeURIComponent(t)); }

function M(t, e) {
    t[e >> 5] |= 128 << e % 32;
    t[14 + (e + 64 >>> 9 << 4)] = e;
    var n, r, a, o, i, c = 1732584193, u = -271733879, s = -1732584194, f = 271733878;
    for (n = 0; n < t.length; n += 16) {
        r = c; a = u; o = s; i = f;
        c=k(c,u,s,f,t[n],7,-680876936); f=k(f,c,u,s,t[n+1],12,-389564586);
        s=k(s,f,c,u,t[n+2],17,606105819); u=k(u,s,f,c,t[n+3],22,-1044525330);
        c=k(c,u,s,f,t[n+4],7,-176418897); f=k(f,c,u,s,t[n+5],12,1200080426);
        s=k(s,f,c,u,t[n+6],17,-1473231341); u=k(u,s,f,c,t[n+7],22,-45705983);
        c=k(c,u,s,f,t[n+8],7,1770035416); f=k(f,c,u,s,t[n+9],12,-1958414417);
        s=k(s,f,c,u,t[n+10],17,-42063); u=k(u,s,f,c,t[n+11],22,-1990404162);
        c=k(c,u,s,f,t[n+12],7,1804603682); f=k(f,c,u,s,t[n+13],12,-40341101);
        s=k(s,f,c,u,t[n+14],17,-1502002290);
        c=P(c,u=k(u,s,f,c,t[n+15],22,1236535329),s,f,t[n+1],5,-165796510);
        f=P(f,c,u,s,t[n+6],9,-1069501632); s=P(s,f,c,u,t[n+11],14,643717713);
        u=P(u,s,f,c,t[n],20,-373897302); c=P(c,u,s,f,t[n+5],5,-701558691);
        f=P(f,c,u,s,t[n+10],9,38016083); s=P(s,f,c,u,t[n+15],14,-660478335);
        u=P(u,s,f,c,t[n+4],20,-405537848); c=P(c,u,s,f,t[n+9],5,568446438);
        f=P(f,c,u,s,t[n+14],9,-1019803690); s=P(s,f,c,u,t[n+3],14,-187363961);
        u=P(u,s,f,c,t[n+8],20,1163531501); c=P(c,u,s,f,t[n+13],5,-1444681467);
        f=P(f,c,u,s,t[n+2],9,-51403784); s=P(s,f,c,u,t[n+7],14,1735328473);
        c=x(c,u=P(u,s,f,c,t[n+12],20,-1926607734),s,f,t[n+5],4,-378558);
        f=x(f,c,u,s,t[n+8],11,-2022574463); s=x(s,f,c,u,t[n+11],16,1839030562);
        u=x(u,s,f,c,t[n+14],23,-35309556); c=x(c,u,s,f,t[n+1],4,-1530992060);
        f=x(f,c,u,s,t[n+4],11,1272893353); s=x(s,f,c,u,t[n+7],16,-155497632);
        u=x(u,s,f,c,t[n+10],23,-1094730640); c=x(c,u,s,f,t[n+13],4,681279174);
        f=x(f,c,u,s,t[n],11,-358537222); s=x(s,f,c,u,t[n+3],16,-722521979);
        u=x(u,s,f,c,t[n+6],23,76029189); c=x(c,u,s,f,t[n+9],4,-640364487);
        f=x(f,c,u,s,t[n+12],11,-421815835); s=x(s,f,c,u,t[n+15],16,530742520);
        c=C(c,u=x(u,s,f,c,t[n+2],23,-995338651),s,f,t[n],6,-198630844);
        f=C(f,c,u,s,t[n+7],10,1126891415); s=C(s,f,c,u,t[n+14],15,-1416354905);
        u=C(u,s,f,c,t[n+5],21,-57434055); c=C(c,u,s,f,t[n+12],6,1700485571);
        f=C(f,c,u,s,t[n+3],10,-1894986606); s=C(s,f,c,u,t[n+10],15,-1051523);
        u=C(u,s,f,c,t[n+1],21,-2054922799); c=C(c,u,s,f,t[n+8],6,1873313359);
        f=C(f,c,u,s,t[n+15],10,-30611744); s=C(s,f,c,u,t[n+6],15,-1560198380);
        u=C(u,s,f,c,t[n+13],21,1309151649); c=C(c,u,s,f,t[n+4],6,-145523070);
        f=C(f,c,u,s,t[n+11],10,-1120210379); s=C(s,f,c,u,t[n+2],15,718787259);
        u=C(u,s,f,c,t[n+9],21,-343485551);
        c=N(c,r); u=N(u,a); s=N(s,o); f=N(f,i);
    }
    return [c, u, s, f];
}

function U(t) {
    var hex = '0123456789abcdef', a = '';
    for (var n = 0; n < t.length; n++) {
        var e = t.charCodeAt(n);
        a += hex.charAt(e >>> 4 & 15) + hex.charAt(15 & e);
    }
    return a;
}

function md5Raw(t) { return w(M(B(O(t)), 8 * O(t).length)); }

function hmacMD5Raw(key, data) {
    var t = O(key), e = O(data), r = B(t), a = [], o = [];
    a[15] = o[15] = void 0;
    if (r.length > 16) {
        var padded = M(r, 8 * t.length);
        for (var n = 0; n < 16; n++) { a[n] = 909522486 ^ padded[n]; o[n] = 1549556828 ^ padded[n]; }
    } else {
        for (var n2 = 0; n2 < 16; n2++) { a[n2] = 909522486 ^ r[n2]; o[n2] = 1549556828 ^ r[n2]; }
    }
    var i = M(a.concat(B(e)), 512 + 8 * e.length);
    return w(M(o.concat(i), 640));
}

function hmacMD5(data, key) {
    if (!key) return U(md5Raw(data));
    return U(hmacMD5Raw(key, data));
}

// ═══════════════════════════════════════════════════════
//  UUID v1
// ═══════════════════════════════════════════════════════

var byteToHex = [];
for (var _i = 0; _i < 256; _i++) byteToHex[_i] = (_i + 256).toString(16).substr(1);

function formatUUID(bytes, offset) {
    var n = offset || 0, r = byteToHex;
    return r[bytes[n]]+r[bytes[n+1]]+r[bytes[n+2]]+r[bytes[n+3]]+'-'
         +r[bytes[n+4]]+r[bytes[n+5]]+'-'
         +r[bytes[n+6]]+r[bytes[n+7]]+'-'
         +r[bytes[n+8]]+r[bytes[n+9]]+'-'
         +r[bytes[n+10]]+r[bytes[n+11]]+r[bytes[n+12]]
         +r[bytes[n+13]]+r[bytes[n+14]]+r[bytes[n+15]];
}

var initRandom = new Uint8Array(16);
crypto.getRandomValues(initRandom);
var node = [1|initRandom[0], initRandom[1], initRandom[2], initRandom[3], initRandom[4], initRandom[5]];
var clockseq = 16383 & (initRandom[6] << 8 | initRandom[7]);
var lastMsecs = 0, lastNsecs = 0;

function uuidV1() {
    var buf = [], idx = 0, s = clockseq;
    var msecs = +new Date, nsecs = lastNsecs + 1;
    var dt = msecs - lastMsecs + (nsecs - lastNsecs) / 1e4;
    if (dt < 0) s = s + 1 & 16383;
    if (dt < 0 || msecs > lastMsecs) nsecs = 0;
    if (nsecs >= 1e4) throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");
    lastMsecs = msecs; lastNsecs = nsecs; clockseq = s;
    msecs += 122192928e5;
    var timeLow = (1e4 * (268435455 & msecs) + nsecs) % 4294967296;
    buf[idx++] = timeLow >>> 24 & 255; buf[idx++] = timeLow >>> 16 & 255;
    buf[idx++] = timeLow >>> 8 & 255;  buf[idx++] = 255 & timeLow;
    var timeMid = msecs / 4294967296 * 1e4 & 268435455;
    buf[idx++] = timeMid >>> 8 & 255;  buf[idx++] = 255 & timeMid;
    buf[idx++] = timeMid >>> 24 & 15 | 16; buf[idx++] = timeMid >>> 16 & 255;
    buf[idx++] = s >>> 8 | 128; buf[idx++] = 255 & s;
    for (var m = 0; m < 6; m++) buf[idx + m] = node[m];
    return formatUUID(buf);
}

// ═══════════════════════════════════════════════════════
//  Payload 加密
// ═══════════════════════════════════════════════════════

function Qf(t, e, n, r, a) {
    return Math.floor((t - e) / (n - e) * (a - r) + r);
}

function getOffsets(paddingLen, payloadLen, uuid) {
    var h = xor(b64encode(uuid), 10);
    var maxProduct = -1;
    for (var p = 0; p < paddingLen; p++) {
        var row = Math.floor(p / h.length) + 1;
        var col = p >= h.length ? p % h.length : p;
        var product = h.charCodeAt(col) * h.charCodeAt(row);
        if (product > maxProduct) maxProduct = product;
    }
    var offsets = [];
    for (var b = 0; b < paddingLen; b++) {
        var row2 = Math.floor(b / h.length) + 1;
        var col2 = b % h.length;
        var product2 = h.charCodeAt(col2) * h.charCodeAt(row2);
        if (product2 >= payloadLen) product2 = Qf(product2, 0, maxProduct, 0, payloadLen - 1);
        while (offsets.indexOf(product2) !== -1) product2 += 1;
        offsets.push(product2);
    }
    return offsets.sort(function(a, b) { return a - b; });
}

function interleave(keyStr, payload, offsets) {
    var result = '', pos = 0, chars = keyStr.split('');
    for (var u = 0; u < keyStr.length; u++) {
        result += payload.substring(pos, offsets[u] - u - 1) + chars[u];
        pos = offsets[u] - u - 1;
    }
    result += payload.substring(pos);
    return result;
}

function generatePayload(events, serverTimestamp, uuid) {
    var json = serialize(events);
    var encrypted = b64encode(xor(json, 50));
    var ts = serverTimestamp || DEFAULT_TIMESTAMP;
    var o = xor(b64encode(String(ts)), 10);
    var offsets = getOffsets(o.length, encrypted.length, uuid);
    return interleave(o, encrypted, offsets);
}

// ═══════════════════════════════════════════════════════
//  PC (payload checksum)
// ═══════════════════════════════════════════════════════

function generatePC(events, uuid, tag, ft) {
    var data = serialize(events);
    var salt = uuid + ':' + tag + ':' + ft;
    var n = hmacMD5(data, salt);
    var digits = '', letters = '';
    for (var r = 0; r < n.length; r++) {
        var a = n.charCodeAt(r);
        if (a >= 48 && a <= 57) digits += n[r];
        else letters += a % 10;
    }
    var combined = digits + letters;
    var pc = '';
    for (var o = 0; o < combined.length; o += 2) pc += combined[o];
    return pc;
}

// ═══════════════════════════════════════════════════════
//  OB 响应解码
// ═══════════════════════════════════════════════════════

function ml(t) {
    var e = 0;
    for (var n = 0; n < t.length; n++) e = (31 * e + t.charCodeAt(n)) % 2147483647;
    return (e % 900 + 100).toString();
}

var UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

function processOb(responseJson, gt) {
    var xorKey = parseInt(ml(gt), 10) % 128;
    var parsed = typeof responseJson === 'string' ? JSON.parse(responseJson) : responseJson;
    var obValue = parsed.do || parsed.ob;
    if (!obValue) return { state: {} };
    var decoded = Buffer.from(obValue, 'base64').toString('binary');
    var segments = xor(decoded, xorKey).split('~~~~');
    var state = {};
    for (var i = 0; i < segments.length; i++) {
        var seg = segments[i];
        if (!seg) continue;
        var fields = seg.split('|');
        fields.shift(); // handler key
        var args = fields;
        // timestamp
        if (args.length === 1 && /^1[5-9]\d{11}$/.test(args[0])) {
            state.no = args[0];
        }
        // challenge hash (cs)
        else if (args.length === 1 && /^[0-9a-f]{64}$/.test(args[0])) {
            state.qa = args[0];
        }
        // vid
        else if (args.length === 3 && UUID_RE.test(args[0]) && /^\d+$/.test(args[1])) {
            state.vid = args[0];
        }
        // cts
        else if (args.length === 2 && UUID_RE.test(args[0])) {
            state.cts = args[0];
        }
        // pxsid
        else if (args.length === 1 && UUID_RE.test(args[0])) {
            state.pxsid = args[0];
        }
        // session_id (to)
        else if ((args.length === 1 || args.length === 2) && /^\d{16,}$/.test(args[0])) {
            state.to = args[0];
        }
        // status code
        else if (args.length === 1 && /^\d{3}$/.test(args[0])) {
            state.ao = args[0];
        }
        // set_cookie (_px3)
        else if (args.length >= 4 && /^_?px/i.test(args[0])) {
            state.px3 = { name: args[0], value: args[2], ttl: +args[1] };
        }
        // app_id
        else if (args.length === 1 && /^[a-z0-9]{12,30}$/.test(args[0])) {
            state.appId = args[0];
        }
        // control flag
        else if (args.length === 1 && /^[a-z]{2,4}$/.test(args[0])) {
            state.jf = args[0];
        }
        // o111ooo1 (unknown handler with 4-5 digit number)
        else if (args.length === 1 && /^\d{4,5}$/.test(args[0])) {
            state.o111val = parseInt(args[0]);
        }
    }
    return { state: state };
}

// ═══════════════════════════════════════════════════════
//  SID 隐写
// ═══════════════════════════════════════════════════════

function hh(t) {
    var result = '';
    for (var i = 0; i < t.length; i++)
        result += String.fromCodePoint(0xE0100 + t.charCodeAt(i));
    return result;
}

function generateSid(pxsid, serverTimestamp) {
    return pxsid + hh(String(serverTimestamp));
}

// ═══════════════════════════════════════════════════════
//  Hash (RT0/ewBRNUo= 字段)
// ═══════════════════════════════════════════════════════

function Kt(t) {
    t = '' + t;
    var e = 0;
    for (var n = 0; n < t.length; n++) { e = (e << 5) - e + t.charCodeAt(n); e |= 0; }
    if (e < 0) e += 4294967296;
    return e.toString(16);
}

function generateHash(serverNo, vid) {
    var ao = Math.floor(parseInt(serverNo) / 1e3);
    return Kt('' + Math.floor((ao * 2863) / vid.charCodeAt(9)));
}

// ═══════════════════════════════════════════════════════
//  Memory 指纹
// ═══════════════════════════════════════════════════════

function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function generateMemory() {
    var used = randInt(40000000, 140000000);
    var total = randInt(Math.floor(used * 1.1), Math.floor(used * 1.5));
    return { usedJSHeapSize: used, totalJSHeapSize: total, jsHeapSizeLimit: 4294967296 };
}

// ═══════════════════════════════════════════════════════
//  /ns 请求
// ═══════════════════════════════════════════════════════

function fetchNs(uuid) {
    var url = 'https://tzm.px-cloud.net/ns?c=' + uuid;
    return new Promise(function(resolve) {
        var start = Date.now();
        https.get(url, function(res) {
            var data = '';
            res.on('data', function(chunk) { data += chunk; });
            res.on('end', function() {
                resolve({ sm: res.statusCode === 200 ? data : null, duration: Date.now() - start });
            });
        }).on('error', function() {
            resolve({ sm: null, duration: Date.now() - start });
        });
    });
}

// ═══════════════════════════════════════════════════════
//  HTTP POST
// ═══════════════════════════════════════════════════════

function postCollector(body, userAgent) {
    return new Promise(function(resolve, reject) {
        var postData = Buffer.from(body, 'utf-8');
        var u = new URL(COLLECTOR_URL);
        var req = https.request({
            hostname: u.hostname, port: 443, path: u.pathname, method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Content-Length': postData.length,
                'Accept': '*/*',
                'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
                'Origin': 'https://www.ifood.com.br',
                'Referer': 'https://www.ifood.com.br/',
                'User-Agent': userAgent,
                'sec-ch-ua': '"Not:A-Brand";v="99", "Microsoft Edge";v="145", "Chromium";v="145"',
                'sec-ch-ua-mobile': '?0',
                'sec-ch-ua-platform': '"Windows"',
            }
        }, function(res) {
            var data = '';
            res.on('data', function(chunk) { data += chunk; });
            res.on('end', function() { resolve({ status: res.statusCode, body: data }); });
        });
        req.on('error', reject);
        req.write(postData);
        req.end();
    });
}

// ═══════════════════════════════════════════════════════
//  主入口
// ═══════════════════════════════════════════════════════

/**
 * 端到端生成 _px3 cookie
 *
 * @param {Object} opts
 * @param {string} opts.userAgent — User-Agent 字符串
 * @returns {Promise<{px3: string, pxvid: string, uuid: string}>}
 */
async function run(opts) {
    var userAgent = opts.userAgent || 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/145.0.0.0 Safari/537.36 Edg/145.0.0.0';
    var uuid = uuidV1();
    var initTime = Date.now();

    // /ns 异步
    var nsPromise = fetchNs(uuid);

    // ── collector#1 ──
    var now1 = Date.now();
    var events1 = [{
        "t": "EFAqFlU5LiE=",
        "d": {
            "U08pSRUgIH4=": "https://www.ifood.com.br/restaurantes",
            "ZR1fGyB2Ui4=": 0,
            "JDxeOmFRVgA=": "Win32",
            "cHAKdjYQB0Y=": 0,
            "Rlp8HAA2dy4=": Math.floor(300 + Math.random() * 1600),
            "JxsdHWJwFCc=": 3600,
            "FCwuKlJGKx0=": initTime,
            "BFw+GkE3Oyg=": now1 + Math.floor(5 + Math.random() * 5),
            "eEgCDj4lBjo=": uuid,
            "Ah44WEdyM24=": null,
            "DFQ2Ekk4PSU=": 0,
            "QSE7ZwdLMVw=": false
        }
    }];

    var payload1 = generatePayload(events1, null, uuid);
    var pc1 = generatePC(events1, uuid, TAG, FT);

    var postBody1 = [
        'payload=' + encodeURIComponent(payload1),
        'appId=' + APP_ID,
        'tag=' + encodeURIComponent(TAG),
        'uuid=' + encodeURIComponent(uuid),
        'ft=' + FT,
        'seq=0', 'en=NTA',
        'bi=' + encodeURIComponent(BI),
        'pc=' + encodeURIComponent(pc1),
        'rsc=1',
    ].join('&');

    var resp1 = await postCollector(postBody1, userAgent);
    if (resp1.status !== 200) throw new Error('collector#1 failed: ' + resp1.status);

    // ── 解码 ob#1 ──
    var ob1 = processOb(resp1.body, GT);
    var state = ob1.state;
    var px3FromOb1 = state.px3 ? state.px3.value : null;

    // ── 等 /ns ──
    var nsResult;
    try { nsResult = await nsPromise; } catch(e) { nsResult = { sm: null, duration: 0 }; }

    // ── collector#2 ──
    var now2 = Date.now();
    var mem = generateMemory();
    var sendDelta = 1000 + Math.floor(Math.random() * 500);
    var sendTs = now2 + sendDelta;
    var perfNow = Math.round(sendTs - initTime);

    var events2 = [{
        "t": "XQUnAxtpIzE=",
        "d": {
            "N2sNLXEGAx4=": state.no,
            "YQFbByRuVjQ=": true,
            "JxsdHWJxEy8=": "109|66|66|70|80",
            "FU1vS1MjYnw=": 1682,
            "ajYQMCxWHgo=": true,
            "LDRWMmpbWwI=": true,
            "a1dRUS4+XmI=": "false",
            "ICBaJmVNVRU=": "false",
            "KDhSPm1QXQg=": 1,
            "ZR1fGyNyUiA=": 1,
            "YQFbByRqXzQ=": "",
            "DzN1dUlScEY=": ["loadTimes","csi","app"],
            "R3s9PQIUOAs=": true,
            "NkpMDHAgQT0=": false,
            "PkJEBHguSDM=": false,
            "OkZAAH8uTjE=": false,
            "TBR2Ugl+f2A=": false,
            "FU1vS1MjYXE=": false,
            "MDBKNnZeRQc=": false,
            "TlJ0FAg4cS8=": false,
            "FCwuKlJNIBE=": false,
            "DzN1dUlefkc=": false,
            "ICBaJmVIVxY=": false,
            "WGhibh4CaFQ=": false,
            "VGxuahEGYl8=": false,
            "VipsLBNGZh8=": false,
            "eWlDLzwGTh4=": [-931.5],
            "BX1/O0AScg4=": false,
            "RT0/ewNcNko=": 1920,
            "DhI0VEh8MWc=": 1080,
            "Ql54GAc2dys=": 1920,
            "RT0/ewBVMEE=": 1032,
            "eydBYT5NRFQ=": "1920X1080",
            "DXV3M0gcegI=": 32,
            "JnpcfGAQWU4=": 32,
            "ICBaJmVPXxI=": 0,
            "KDhSPm1XVws=": 0,
            "eWlDLz8ERxk=": 1872,
            "DFQ2Ekk5OiE=": 948,
            "bRVXEyh4XiI=": 0,
            "DFQ2Ekk5Pyc=": 0,
            "NkpMDHAmQj0=": true,
            "Ql54GAc3ciM=": false,
            "fyNFZTpPQF8=": "webkit",
            "W0chQR4rKXI=": "https:",
            "MDBKNnVcQgY=": "function share() { [native code] }",
            "b1NVVSo/XWQ=": "Asia/Shanghai",
            "KVkTX2w1GGo=": "w3c",
            "KnZQcG8aWkQ=": "screen",
            "VipsLBNFZh8=": false,
            "KDhSPm1UWgk=": {"plugext":{"0":{"f":"internal-pdf-viewer","n":"PDF Viewer"},"1":{"f":"internal-pdf-viewer","n":"Chrome PDF Viewer"},"2":{"f":"internal-pdf-viewer","n":"Chromium PDF Viewer"},"3":{"f":"internal-pdf-viewer","n":"Microsoft Edge PDF Viewer"},"4":{"f":"internal-pdf-viewer","n":"WebKit built-in PDF"}},"plugins_len":5},
            "aRlTHyx1Vi4=": {"smd":{"ok":true,"ex":false}},
            "HCQmIllILBg=": {},
            "W0chQR4rJXc=": false,
            "M28JKXYDAh0=": false,
            "VipsLBNGZh8=": "f1a38a60",
            "EFAqFlU8IC0=": {"support":true,"status":{"effectiveType":"4g","rtt":0,"downlink":9.5,"saveData":false}},
            "O2cBIX4LBBI=": "default",
            "FmosbFMGKVw=": 3,
            "OkZAAH8qRTU=": false,
            "RT0/ewBRNUo=": generateHash(state.no, state.vid),
            "fgIERDtrD38=": ["PDF Viewer","Chrome PDF Viewer","Chromium PDF Viewer","Microsoft Edge PDF Viewer","WebKit built-in PDF"],
            "UBBqVhV7b2I=": 5,
            "CFgyHk40OCo=": true,
            "aHgSfi0SHkQ=": true,
            "QAB6RgZqf3A=": true,
            "NAxOSnJtS34=": true,
            "eydBYT1LRFA=": "zh-CN",
            "JDxeOmFRVgA=": "Win32",
            "LDRWMmpbUwE=": ["zh-CN","en","en-GB","en-US"],
            "fgIERDhsDHI=": userAgent,
            "NS0Pa3BEAV4=": true,
            "FU1vS1Mna3k=": -480,
            "X0MlRRksKnY=": 8,
            "cy9JaTVAQVw=": 4,
            "SlZwEA8/dSM=": "Gecko",
            "b1NVVSkzWG8=": "20030107",
            "LnJUdGsYWEI=": "5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/145.0.0.0 Safari/537.36 Edg/145.0.0.0",
            "FCwuKlJNIRE=": true,
            "UBBqVhZ9YWA=": true,
            "VGxuahEFZlw=": 2,
            "aHgSfi4ZHU0=": "Netscape",
            "SBhyXg51eGU=": "Mozilla",
            "Z1tdXSE0V2s=": true,
            "QAB6RgVrc3U=": 0,
            "RT0/ewNXNUs=": false,
            "S3cxMQ0YNAA=": 9.5,
            "OSkDb39FCFw=": "4g",
            "HwNlBVlibzA=": true,
            "O2cBIX4PDBM=": true,
            "GUljT1wmaHw=": true,
            "egYAQD9qDXQ=": "x86",
            "WiZgIB9KbRU=": "64",
            "Mk5ICHciRTI=": [{"brand":"Not:A-Brand","version":"99"},{"brand":"Microsoft Edge","version":"145"},{"brand":"Chromium","version":"145"}],
            "IUEbR2QtFnw=": false,
            "ZHweeiEQEkg=": "",
            "VGxuahEAYlk=": "Windows",
            "OkZAAH8qTDA=": "19.0.0",
            "AEA6BkUsNjc=": "145.0.3800.70",
            "XGRmYhkIb1g=": true,
            "FU1vS1AhZnA=": true,
            "Em4oaFcEI1g=": "f49f18dbec5558a76590af096c339826",
            "VGxuahEDa1A=": true,
            "OkZAAHwpRTc=": 16,
            "T3M1NQocPwU=": false,
            "O2cBIX0LDBs=": "49e5084e",
            "OSkDb39EC18=": "7c5f9724",
            "BFw+GkE3MiA=": "65d826e0",
            "Bzt9fUJWeE4=": "a9269e00",
            "SlZwEAw4dSI=": "50a5ec55",
            "DzN1dUpcfkU=": "73a0fb26",
            "eydBYT5ISlc=": true,
            "OSkDb3xGCFg=": true,
            "cRFLFzR+QCM=": true,
            "CXlzP0wWeAo=": false,
            "WQkjDxxmKDU=": true,
            "PARGQnlrTXk=": true,
            "KnZQcG8ZWkI=": true,
            "YGAaZiYMFV0=": mem.usedJSHeapSize,
            "FU1vS1MhZ3w=": mem.jsHeapSizeLimit,
            "EFAqFlYxJCc=": mem.totalJSHeapSize,
            "eWlDLz8ISh0=": new Date(now2).toString(),
            "ZjocPCBWEwg=": false,
            "Bzt9fUFUeEs=": false,
            "XiJkJBhDaBQ=": false,
            "HCQmIllOKBU=": true,
            "HmIkZFsLIVY=": 0,
            "XiJkJBhNbh4=": false,
            "aHgSfi4SG0U=": "hidden",
            "Mk5ICHckTD0=": false,
            "UBBqVhZ6b2M=": 0,
            "BFw+GkE0Nig=": 1920,
            "bHQWcikeG0Q=": false,
            "Bzt9fUFUdU4=": 1032,
            "CFgyHk45OSs=": "missing",
            "Ix8ZGWZ0ES8=": true,
            "GCgiLl5EKxw=": true,
            "Ui5oKBRCYRI=": false,
            "Z1tdXSE2VGk=": true,
            "eWlDLzwFSx0=": 1,
            "Y19ZWSYyV2o=": 0,
            "LVUXU2s1E2A=": 9,
            "LxMVFWlyGyA=": 8,
            "VQ0vCxNiITs=": 8,
            "JDxeOmJRUwE=": 8,
            "DXV3M0gZcwY=": 2,
            "ZR1fGyB2Ui4=": 0,
            "STkzfw9VPUU=": 2,
            "cHAKdjYQD0A=": "TypeError: Cannot read properties of null (reading '0')\n    at _r (https://client.px-cloud.net/PXO1GDTa7Q/main.min.js:1208:21)\n    at Kd (https://client.px-cloud.net/PXO1GDTa7Q/main.min.js:6529:27)\n    at Zd (https://client.px-cloud.net/PXO1GDTa7Q/main.min.js:6157:30)\n    at https://client.px-cloud.net/PXO1GDTa7Q/main.min.js:5857:17\n    at r (https://www.ifood.com.br/_next/static/chunks/pages/_app-8759a56d911cf8d5.js:3:3515401)",
            "U08pSRUgIH4=": "https://www.ifood.com.br/",
            "ajYQMCxaFAU=": [],
            "FU1vS1AkYHo=": "https%3A%2F%2Fwww.ifood.com.br%2F",
            "Ql54GAQ0di0=": false,
            "DzN1dUpffEM=": true,
            "LxMVFWp8GCU=": "3Jzg9oNbX",
            "HUVnQ1sranA=": state.to,
            "Em4oaFcDIF4=": state.o111val || '',
            "KVkTX281HWQ=": "64556c77",
            "V0stTREnInc=": "",
            "Az95eUZUc0o=": "10207b2f",
            "SlZwEAw3eSs=": "10207b2f",
            "VipsLBNHZxo=": "90e65465",
            "Yj4YOCRUEAw=": true,
            "aRlTHyx0XCs=": true,
            "Rlp8HAA0eC8=": true,
            "TTU3cwtZO0Y=": true,
            "SlZwEA86fyI=": true,
            "VQ0vCxBhID0=": "4YC/4YCb4YCR4YCA4YCd4YCB4YCd4YCU4YCG4YGS4YCi4YCT4YCH4YCe4YCb4YCc4YCT4YGS4YC94YCc4YCe4YCb4YCc4YCX4YGS4YGf4YGS4YCi4YCd4YCe4YCb4YCB4YCa4YGS4YGa4YCi4YCd4YCe4YCT4YCc4YCW4YGb",
            "Yj4YOCdSFw0=": "3207084bd110f1ac964863e23aa78e04",
            "FU1vS1Agan8=": null,
            "KVkTX2wyGG0=": userAgent,
            "a1dRUS48WGo=": false,
            "NkpMDHArSDk=": "90e65465",
            "fyNFZTlCSFM=": hmacMD5(uuid, userAgent),
            "dEwOCjEkAjA=": state.appId,
            "dgoMTDBkBXg=": hmacMD5(state.vid, userAgent),
            "dEwOCjImBDk=": hmacMD5(state.pxsid, userAgent),
            "BFw+GkEwMyk=": hmacMD5(state.vid),
            "R3s9PQIQNwc=": true,
            "Rlp8HAA1eCo=": false,
            "NkpMDHMhSDo=": false,
            "dW1PKzABQx0=": true,
            "MVELV3Q9B2A=": "TypeError: Cannot read properties of undefined (reading 'width')",
            "dytNbTJHQVk=": "webkit",
            "XQUnAxhpKzY=": 33,
            "RBx+WgFwcmA=": false,
            "LxMVFWp/HCI=": false,
            "fgIERDtuAHU=": false,
            "Z1tdXSI3WWo=": "AudioData.SVGAnimatedAngle.SVGMetadataElement",
            "WiZgIB9JbRc=": "jgS",
            "EFAqFlU/Jy0=": "vaz*+UR!<c(URM8",
            "Rlp8HAMydyc=": 1,
            "cHAKdjYQB0Y=": 1,
            "Rlp8HAA2dy4=": perfNow,
            "Yj4YOCRUFgg=": now2,
            "JxsdHWJwFCc=": 3600,
            "FCwuKlJGKx0=": initTime,
            "BFw+GkE3Oyg=": sendTs,
            "eEgCDj4lBjo=": uuid,
            "Ah44WEdyM24=": nsResult.sm || null,
            "DFQ2Ekk4PSU=": nsResult.duration || 0,
            "QSE7ZwdLMVw=": false,
            "BX1/O0ATcgo=": px3FromOb1 || ""
        }
    }];

    // Anti-tamper
    var stateNo = parseInt(state.no);
    events2[0].d[te(state.to, stateNo % 10 + 2)] = te(state.to, stateNo % 10 + 1);

    var payload2 = generatePayload(events2, state.no, uuid);
    var pc2 = generatePC(events2, uuid, TAG, FT);
    var sid = generateSid(state.pxsid, state.no);

    var postBody2 = [
        'payload=' + encodeURIComponent(payload2),
        'appId=' + APP_ID,
        'tag=' + encodeURIComponent(TAG),
        'uuid=' + encodeURIComponent(uuid),
        'ft=' + FT,
        'seq=2', 'en=NTA',
        'bi=' + encodeURIComponent(BI),
        'cs=' + encodeURIComponent(state.qa),
        'pc=' + encodeURIComponent(pc2),
        'sid=' + encodeURIComponent(sid),
        'vid=' + encodeURIComponent(state.vid),
        'cts=' + encodeURIComponent(state.cts),
        'rsc=2',
    ].join('&');

    var resp2 = await postCollector(postBody2, userAgent);

    // 提取 _px3
    var px3Final = px3FromOb1;
    try {
        var doArr = JSON.parse(resp2.body).do || [];
        for (var j = 0; j < doArr.length; j++) {
            if (typeof doArr[j] === 'string' && doArr[j].startsWith('bake|_px3|'))
                px3Final = doArr[j].split('|')[2];
        }
    } catch(e) {}

    return {
        px3: px3Final,
        pxvid: state.vid,
        uuid: uuid,
        status: resp2.status,
        response: resp2.body,
    };
}

// ═══════════════════════════════════════════════════════
//  导出
// ═══════════════════════════════════════════════════════

module.exports = {
    run,
    uuidV1,
    generatePayload,
    generatePC,
    processOb,
    generateSid,
    generateHash,
    generateMemory,
    hmacMD5,
    serialize,
    b64encode,
    b64decode_utf8,
    xor,
    te,
    Kt,
};
```

### 使用示例

```javascript
const px = require('./px_pure');

(async () => {
    var result = await px.run({
        userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...'
    });
    console.log('_px3:', result.px3);
    console.log('_pxvid:', result.pxvid);
})();
```
